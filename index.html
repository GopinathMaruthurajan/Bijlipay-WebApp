<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 500px;
        }

        /* (Keep all your existing styles the same) */
        /* ... (All your previous CSS styles remain unchanged) ... */
        
    </style>
</head>
<body>
    <div class="container" id="paymentForm">
        <h1>Payment Gateway</h1>

        <div class="invoice-display">
            Invoice Number: <span id="invoiceNumber">INV-</span>
        </div>

        <div class="form-group">
            <label for="billNumber">Customer Bill Number</label>
            <input type="text" id="billNumber" placeholder="Enter bill number">
        </div>

        <label>Payment Mode</label>
        <div class="payment-modes">
            <div class="payment-mode" onclick="selectPaymentMode('card')">
                <img src="https://cdn-icons-png.flaticon.com/512/179/179457.png" width="50" alt="Card">
                <p>Card</p>
            </div>
            <div class="payment-mode" onclick="selectPaymentMode('qr')">
                <img src="https://cdn-icons-png.flaticon.com/512/3916/3916907.png" width="50" alt="Scan QR">
                <p>Scan QR</p>
            </div>
        </div>

        <input type="hidden" id="selectedPaymentMode" value="">

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Processing payment...</p>
        </div>

        <button class="btn" onclick="initiatePayment()">Pay Now</button>
    </div>

    <div class="container" id="paymentReceipt" style="display: none;">
        <div class="success-message">Payment Successful!</div>

        <div class="invoice-details" id="invoiceDetails">
            <!-- (Keep your receipt details structure the same) -->
            <!-- ... (All your receipt HTML remains unchanged) ... -->
        </div>

        <button class="btn" style="margin-top: 20px;" onclick="location.reload()">New Payment</button>
    </div>

    <script>
        // Generate random invoice number
        function generateInvoiceNumber() {
            const invoiceNumber = 'INV-' + Math.floor(100000 + Math.random() * 900000);
            document.getElementById('invoiceNumber').textContent = invoiceNumber;
            document.getElementById('receiptInvoice').textContent = invoiceNumber;
            return invoiceNumber;
        }

        // Set current date
        function setCurrentDate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('receiptDate').textContent = now.toLocaleDateString('en-IN', options);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            generateInvoiceNumber();
            setCurrentDate();
        });

        // Payment mode selection
        function selectPaymentMode(mode) {
            const modes = document.querySelectorAll('.payment-mode');
            modes.forEach(m => m.classList.remove('selected'));

            const selectedMode = document.querySelector(`.payment-mode[onclick="selectPaymentMode('${mode}')"]`);
            selectedMode.classList.add('selected');

            document.getElementById('selectedPaymentMode').value = mode;
            document.getElementById('receiptMethod').textContent = mode === 'card' ? 'Credit/Debit Card' : 'QR Code Payment';
        }

        // Initiate payment process (Updated Hybrid Approach)
        function initiatePayment() {
            const billNumber = document.getElementById('billNumber').value;
            const paymentMode = document.getElementById('selectedPaymentMode').value;
            const invoiceNumber = document.getElementById('invoiceNumber').textContent;

            if (!billNumber) {
                alert('Please enter bill number');
                return;
            }

            if (!paymentMode) {
                alert('Please select payment mode');
                return;
            }

            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';

            // Prepare payment data
            const paymentData = {
                invoiceNumber: invoiceNumber,
                billNumber: billNumber,
                amount: 1299.00,
                paymentMode: paymentMode,
                timestamp: new Date().toISOString()
            };

            // Try URL scheme first
            try {
                window.location.href = `payment://pay?${new URLSearchParams(paymentData).toString()}`;
                
                // Fallback to JavaScript interface if URL scheme fails
                setTimeout(() => {
                    if (typeof Android !== 'undefined' && Android.initiatePayment) {
                        Android.initiatePayment(JSON.stringify(paymentData));
                    } else {
                        // Final fallback for testing
                        console.log("Simulating payment with:", paymentData);
                        setTimeout(() => {
                            showPaymentSuccess(paymentData);
                        }, 2000);
                    }
                }, 500);
            } catch (e) {
                console.error("URL scheme failed, trying JavaScript interface:", e);
                if (typeof Android !== 'undefined' && Android.initiatePayment) {
                    Android.initiatePayment(JSON.stringify(paymentData));
                } else {
                    showPaymentSuccess(paymentData);
                }
            }
        }

        // Show payment success with invoice details
        function showPaymentSuccess(paymentData) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'none';
            document.getElementById('paymentReceipt').style.display = 'block';
            document.getElementById('invoiceDetails').style.display = 'block';

            // Set receipt details
            document.getElementById('receiptBill').textContent = paymentData.billNumber;
            document.getElementById('receiptTxn').textContent = 'TXN' + Math.floor(10000000 + Math.random() * 90000000);
            document.getElementById('receiptAmount').textContent = paymentData.amount.toFixed(2);
        }

        // Handle payment completion from Android
        function onPaymentCompleted(response) {
            try {
                const result = JSON.parse(response);
                if (result.status === "SUCCESS") {
                    showPaymentSuccess({
                        invoiceNumber: result.invoiceNumber,
                        billNumber: document.getElementById('billNumber').value,
                        amount: result.amount,
                        paymentMode: document.getElementById('selectedPaymentMode').value
                    });
                } else {
                    alert("Payment failed: " + (result.message || "Unknown error"));
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            } catch (e) {
                console.error("Error processing payment response:", e);
                alert("Payment processing error");
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // Expose to Android webview
        window.onPaymentCompleted = onPaymentCompleted;
    </script>
</body>
</html>